---
- name: Configuration de l'exp√©dition des logs vers Loki
  hosts: builders
  become: yes
  vars:
    loki_ip: "192.168.20.103"
    loki_port: 3100

  tasks:
    - name: 1. Installation du plugin Docker Loki
      shell: docker plugin install grafana/loki-docker-driver:latest --alias loki --grant-all-permissions
      register: plugin_install
      failed_when: 
        - plugin_install.rc != 0 
        - '"already exists" not in plugin_install.stderr'

    - name: 2. Configuration du Daemon Docker
      copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "log-driver": "loki",
            "log-opts": {
              "loki-url": "http://{{ loki_ip }}:{{ loki_port }}/loki/api/v1/push",
              "loki-batch-size": "400"
            }
          }
      notify: Restart Docker

  handlers:
    - name: Restart Docker
      service:
        name: docker
        state: restarted
